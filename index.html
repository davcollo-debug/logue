<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Logue - AI Running Coach</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDKs (for Firestore only, no auth) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Firebase Configuration (Firestore only)
        const FIREBASE_CONFIG = {
          apiKey: "AIzaSyCNDL5acClE7hbR2xshZtgrzSiJk7jq1Ko",
          authDomain: "logue-coach-app.firebaseapp.com",
          projectId: "logue-coach-app",
          storageBucket: "logue-coach-app.firebasestorage.app",
          messagingSenderId: "513654365822",
          appId: "1:513654365822:web:84835e52ba217cd255422f"
        };

        // Strava Configuration
        const STRAVA_CLIENT_ID = "184757";
        const API_BASE = "https://logue.vercel.app";

        // Initialize Firebase (Firestore only)
        if (!firebase.apps.length) {
          firebase.initializeApp(FIREBASE_CONFIG);
        }
        const db = firebase.firestore();

        // Icons
        const Activity = (props) => (
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
            <path d="M22 12h-2.48a2 2 0 0 0-1.93 1.46l-2.35 8.36a.25.25 0 0 1-.48 0L9.24 2.18a.25.25 0 0 0-.48 0l-2.35 8.36A2 2 0 0 1 4.49 12H2"/>
          </svg>
        );

        const Send = (props) => (
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
            <path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/>
          </svg>
        );

        const Heart = (props) => (
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
            <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/>
          </svg>
        );

        const Zap = (props) => (
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
            <path d="M4 14a1 1 0 0 1-.78-1.63l9.9-10.2a.5.5 0 0 1 .86.46l-1.92 6.02A1 1 0 0 0 13 10h7a1 1 0 0 1 .78 1.63l-9.9 10.2a.5.5 0 0 1-.86-.46l1.92-6.02A1 1 0 0 0 11 14z"/>
          </svg>
        );

        const RefreshCw = (props) => (
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
            <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M3 21v-5h5"/>
          </svg>
        );

        const LogOut = (props) => (
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/>
          </svg>
        );

        const Logue = () => {
          const [user, setUser] = useState(null);
          const [loading, setLoading] = useState(true);
          const [activities, setActivities] = useState([]);
          const [messages, setMessages] = useState([]);
          const [userInput, setUserInput] = useState('');
          const [chatLoading, setChatLoading] = useState(false);
          const [syncing, setSyncing] = useState(false);
          const messagesEndRef = useRef(null);

          useEffect(() => {
            // Check if user is stored in localStorage
            const storedUser = localStorage.getItem('logue_user');
            if (storedUser) {
              const userData = JSON.parse(storedUser);
              setUser(userData);
              loadUserData(userData.athleteId);
            }
            handleStravaCallback();
            setLoading(false);
          }, []);

          useEffect(() => {
            scrollToBottom();
          }, [messages]);

          const connectStrava = () => {
            const redirectUri = window.location.origin;
            const state = Math.random().toString(36).substring(7);
            localStorage.setItem('strava_state', state);
            const authUrl = `https://www.strava.com/oauth/authorize?client_id=${STRAVA_CLIENT_ID}&redirect_uri=${redirectUri}&response_type=code&scope=read,activity:read_all&state=${state}`;
            window.location.href = authUrl;
          };

          const handleStravaCallback = async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const state = urlParams.get('state');
            const storedState = localStorage.getItem('strava_state');
            
            if (code && state === storedState) {
              try {
                setSyncing(true);
                
                const response = await fetch(`${API_BASE}/api/strava-token`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ code })
                });
                
                if (!response.ok) throw new Error('Token exchange failed');
                
                const data = await response.json();
                
                const userData = {
                  athleteId: data.athlete.id.toString(),
                  name: `${data.athlete.firstname} ${data.athlete.lastname}`,
                  stravaToken: data.access_token,
                  stravaRefreshToken: data.refresh_token,
                  stravaExpiresAt: data.expires_at
                };
                
                // Store user in localStorage
                localStorage.setItem('logue_user', JSON.stringify(userData));
                setUser(userData);
                
                // Save to Firestore
                await db.collection('users').doc(userData.athleteId).set({
                  name: userData.name,
                  stravaToken: userData.stravaToken,
                  stravaRefreshToken: userData.stravaRefreshToken,
                  stravaExpiresAt: userData.stravaExpiresAt,
                  lastSync: null
                }, { merge: true });
                
                await syncActivities(userData);
                window.history.replaceState({}, document.title, window.location.pathname);
                localStorage.removeItem('strava_state');
                setSyncing(false);
              } catch (error) {
                console.error('Strava auth error:', error);
                alert('Failed to connect to Strava: ' + error.message);
                setSyncing(false);
              }
            }
          };

          const loadUserData = async (athleteId) => {
            try {
              const activitiesSnap = await db.collection('users').doc(athleteId).collection('activities')
                .orderBy('date', 'desc')
                .limit(10)
                .get();
              const acts = activitiesSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
              setActivities(acts);
              
              const messagesSnap = await db.collection('users').doc(athleteId).collection('messages')
                .orderBy('timestamp', 'asc')
                .get();
              const msgs = messagesSnap.docs.map(doc => doc.data());
              
              setMessages(msgs);
            } catch (error) {
              console.error('Error loading user data:', error);
            }
          };

          const syncActivities = async (userData = user) => {
            if (!userData) return;
            
            setSyncing(true);
            
            try {
              const response = await fetch(`${API_BASE}/api/strava-sync`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token: userData.stravaToken })
              });
              
              if (!response.ok) throw new Error('Sync failed');
              
              const { activities: newActivities } = await response.json();
              
              const activitiesRef = db.collection('users').doc(userData.athleteId).collection('activities');
              
              for (const activity of newActivities) {
                await activitiesRef.doc(activity.stravaId.toString()).set(activity);
              }
              
              await db.collection('users').doc(userData.athleteId).set({ 
                lastSync: new Date().toISOString() 
              }, { merge: true });
              
              await loadUserData(userData.athleteId);
              
              if (newActivities.length > 0) {
                const syncMsg = {
                  role: 'assistant',
                  content: `✅ Synced ${newActivities.length} activities from Strava! Let me analyze your training...`,
                  timestamp: Date.now()
                };
                setMessages(prev => [...prev, syncMsg]);
                await saveMessage(userData.athleteId, syncMsg);
                
                await analyzeActivities(newActivities, userData.athleteId);
              }
            } catch (error) {
              console.error('Sync error:', error);
              alert('Sync failed: ' + error.message);
            }
            
            setSyncing(false);
          };

          const saveMessage = async (athleteId, message) => {
            try {
              await db.collection('users').doc(athleteId).collection('messages').add(message);
            } catch (error) {
              console.error('Error saving message:', error);
            }
          };

          const analyzeActivities = async (activitiesData, athleteId) => {
            setChatLoading(true);
            
            try {
              const activitySummary = activitiesData.map(a => ({
                name: a.name,
                distance_km: a.distance,
                pace_per_km: a.pace,
                avg_hr: a.avgHeartrate,
                max_hr: a.maxHeartrate,
                cadence: a.cadence,
                date: new Date(a.date).toLocaleDateString()
              }));

              const analysisPrompt = `You are Logue, an expert running coach. I've just synced ${activitiesData.length} activities from Strava. 

Here's the data:
${JSON.stringify(activitySummary, null, 2)}

Your task:
1. Analyze this training data and give a 2-3 sentence summary of what you observe (frequency, pace patterns, heart rate trends, etc.)
2. Then ask: "What are you training for?" and give examples like: specific race, building fitness, comeback from injury, staying active

Be conversational, specific about the numbers you see, and show you've actually analyzed their data.`;

              const response = await fetch(`${API_BASE}/api/claude-chat`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  max_tokens: 1000,
                  messages: [{ role: 'user', content: analysisPrompt }]
                })
              });

              const data = await response.json();
              const reply = data.content.find(c => c.type === 'text')?.text || 'Error analyzing activities.';
              
              const analysisMessage = {
                role: 'assistant',
                content: reply,
                timestamp: Date.now()
              };
              
              setMessages(prev => [...prev, analysisMessage]);
              await saveMessage(athleteId, analysisMessage);
              
            } catch (error) {
              console.error('Analysis error:', error);
            }
            
            setChatLoading(false);
          };

          const sendMessage = async () => {
            if (!userInput.trim() || chatLoading || !user) return;

            const newUserMessage = { 
              role: 'user', 
              content: userInput,
              timestamp: Date.now()
            };
            
            setMessages(prev => [...prev, newUserMessage]);
            await saveMessage(user.athleteId, newUserMessage);
            setUserInput('');
            setChatLoading(true);

            try {
              const activityContext = activities.map(a => ({
                name: a.name,
                distance_km: a.distance,
                pace_per_km: a.pace,
                avg_hr: a.avgHeartrate,
                max_hr: a.maxHeartrate,
                cadence: a.cadence,
                date: new Date(a.date).toLocaleDateString()
              }));

              const conversationHistory = messages.slice(-10).map(m => ({
                role: m.role,
                content: m.content
              }));

              const systemPrompt = `You are Logue, an expert running coach. Analyze Strava data critically and ask specific questions about HR, cadence, pacing. Be proactive about concerning patterns.

Recent activities: ${JSON.stringify(activityContext, null, 2)}`;

              const response = await fetch(`${API_BASE}/api/claude-chat`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  system: systemPrompt,
                  max_tokens: 2000,
                  messages: [...conversationHistory, { role: 'user', content: userInput }]
                })
              });

              const data = await response.json();
              const reply = data.content.find(c => c.type === 'text')?.text || 'Sorry, error occurred.';
              
              const assistantMessage = {
                role: 'assistant',
                content: reply,
                timestamp: Date.now()
              };
              
              setMessages(prev => [...prev, assistantMessage]);
              await saveMessage(user.athleteId, assistantMessage);
              
            } catch (error) {
              console.error('Error:', error);
            }

            setChatLoading(false);
          };

          const signOut = () => {
            localStorage.removeItem('logue_user');
            setUser(null);
            setActivities([]);
            setMessages([]);
          };

          const scrollToBottom = () => {
            messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
          };

          if (loading) {
            return (
              <div className="min-h-screen bg-gray-50 flex items-center justify-center">
                <Activity className="w-12 h-12 text-orange-500 animate-pulse" />
              </div>
            );
          }

          if (!user) {
            return (
              <div className="min-h-screen bg-gradient-to-br from-orange-500 to-red-600 flex items-center justify-center p-4">
                <div className="bg-white rounded-2xl shadow-2xl p-12 max-w-2xl w-full text-center">
                  <Activity className="w-20 h-20 mx-auto mb-6 text-orange-500" />
                  <h1 className="text-4xl font-bold text-gray-800 mb-4">Logue</h1>
                  <p className="text-xl text-gray-600 mb-8">
                    Your AI running coach powered by Strava
                  </p>
                  
                  {syncing ? (
                    <div className="flex items-center justify-center gap-3 text-orange-600">
                      <RefreshCw className="w-6 h-6 animate-spin" />
                      <span>Connecting to Strava...</span>
                    </div>
                  ) : (
                    <button
                      onClick={connectStrava}
                      className="bg-orange-500 text-white py-4 px-8 rounded-lg font-semibold hover:bg-orange-600 transition inline-flex items-center gap-3 text-lg"
                    >
                      <img 
                        src="https://upload.wikimedia.org/wikipedia/commons/c/cb/Strava_Logo.svg" 
                        alt="Strava" 
                        className="h-6"
                      />
                      Connect with Strava
                    </button>
                  )}
                </div>
              </div>
            );
          }

          return (
            <div className="h-screen flex flex-col bg-gray-50">
              <div className="bg-white border-b px-6 py-4 flex items-center justify-between shadow-sm">
                <div className="flex items-center gap-3">
                  <Activity className="w-6 h-6 text-orange-500" />
                  <h1 className="text-lg font-semibold text-gray-800">Logue</h1>
                  <span className="text-sm text-gray-500">• {user.name.split(' ')[0]}</span>
                </div>
                <div className="flex items-center gap-4">
                  <button
                    onClick={() => syncActivities()}
                    disabled={syncing}
                    className="flex items-center gap-2 text-sm text-gray-600 hover:text-gray-800 transition disabled:opacity-50"
                  >
                    <RefreshCw className={`w-4 h-4 ${syncing ? 'animate-spin' : ''}`} />
                    {syncing ? 'Syncing...' : 'Sync'}
                  </button>
                  <button onClick={signOut} className="flex items-center gap-2 text-sm text-gray-600 hover:text-gray-800">
                    <LogOut className="w-4 h-4" />
                    Sign Out
                  </button>
                </div>
              </div>

              <div className="flex-1 flex overflow-hidden">
                <div className="w-1/2 flex flex-col bg-white border-r">
                  <div className="px-6 py-4 border-b bg-gray-50">
                    <h2 className="font-semibold text-gray-700">Chat with Your Coach</h2>
                  </div>

                  <div className="flex-1 overflow-y-auto px-6 py-6 space-y-6">
                    {messages.map((msg, idx) => (
                      <div key={idx} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                        <div className={`max-w-[85%] ${
                          msg.role === 'user' 
                            ? 'bg-orange-500 text-white rounded-2xl rounded-br-sm' 
                            : 'bg-gray-100 text-gray-800 rounded-2xl rounded-bl-sm'
                        } px-5 py-3 shadow-sm`}>
                          <p className="text-sm leading-relaxed whitespace-pre-wrap">{msg.content}</p>
                        </div>
                      </div>
                    ))}
                    
                    {chatLoading && (
                      <div className="flex justify-start">
                        <div className="bg-gray-100 rounded-2xl rounded-bl-sm px-5 py-3">
                          <div className="flex gap-1.5">
                            <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                            <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{ animationDelay: '0.1s' }}></div>
                            <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{ animationDelay: '0.2s' }}></div>
                          </div>
                        </div>
                      </div>
                    )}
                    <div ref={messagesEndRef} />
                  </div>

                  <div className="border-t bg-white px-6 py-4">
                    <div className="flex gap-3">
                      <input
                        type="text"
                        value={userInput}
                        onChange={(e) => setUserInput(e.target.value)}
                        onKeyPress={(e) => e.key === 'Enter' && sendMessage()}
                        placeholder="Type your message..."
                        className="flex-1 px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-orange-500"
                        disabled={chatLoading}
                      />
                      <button
                        onClick={sendMessage}
                        disabled={chatLoading || !userInput.trim()}
                        className="bg-orange-500 text-white p-3 rounded-xl hover:bg-orange-600 disabled:opacity-40"
                      >
                        <Send className="w-5 h-5" />
                      </button>
                    </div>
                  </div>
                </div>

                <div className="w-1/2 flex flex-col bg-gray-50">
                  <div className="px-6 py-4 border-b bg-white">
                    <h2 className="font-semibold text-gray-700">Recent Activities</h2>
                  </div>

                  <div className="flex-1 overflow-y-auto p-6 space-y-3">
                    {activities.length === 0 ? (
                      <div className="text-center py-12 text-gray-400">
                        <Activity className="w-16 h-16 mx-auto mb-4 opacity-50" />
                        <p>No activities yet</p>
                        <p className="text-sm mt-2">Click Sync to load from Strava</p>
                      </div>
                    ) : (
                      activities.map(activity => (
                        <div key={activity.id} className="bg-white rounded-lg p-4 border-2 border-gray-200">
                          <div className="flex items-start justify-between mb-3">
                            <div>
                              <h3 className="font-semibold text-gray-800">{activity.name}</h3>
                              <p className="text-sm text-gray-500">{new Date(activity.date).toLocaleDateString()}</p>
                            </div>
                          </div>
                          <div className="grid grid-cols-2 gap-3 text-sm">
                            <div>
                              <p className="text-gray-500">Distance</p>
                              <p className="font-semibold text-gray-800">{activity.distance} km</p>
                            </div>
                            <div>
                              <p className="text-gray-500">Pace</p>
                              <p className="font-semibold text-gray-800">{activity.pace}/km</p>
                            </div>
                            <div>
                              <p className="text-gray-500 flex items-center gap-1">
                                <Heart className="w-3 h-3" /> Avg HR
                              </p>
                              <p className="font-semibold">{activity.avgHeartrate} bpm</p>
                            </div>
                            <div>
                              <p className="text-gray-500 flex items-center gap-1">
                                <Zap className="w-3 h-3" /> Cadence
                              </p>
                              <p className="font-semibold">{activity.cadence} spm</p>
                            </div>
                          </div>
                        </div>
                      ))
                    )}
                  </div>
                </div>
              </div>
            </div>
          );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<Logue />);
    </script>
</body>
</html>
