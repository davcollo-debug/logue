<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Logue - AI Running Coach</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Firebase Configuration
        const FIREBASE_CONFIG = {
          apiKey: "AIzaSyCNDL5acClE7hbR2xshZtgrzSiJk7jq1Ko",
          authDomain: "logue-coach-app.firebaseapp.com",
          projectId: "logue-coach-app",
          storageBucket: "logue-coach-app.firebasestorage.app",
          messagingSenderId: "513654365822",
          appId: "1:513654365822:web:84835e52ba217cd255422f"
        };

        // Strava Configuration
        const STRAVA_CLIENT_ID = "184757";
        const API_BASE = "https://logue.vercel.app";

        // Lucide Icons as SVG components
        const Activity = (props) => (
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
            <path d="M22 12h-2.48a2 2 0 0 0-1.93 1.46l-2.35 8.36a.25.25 0 0 1-.48 0L9.24 2.18a.25.25 0 0 0-.48 0l-2.35 8.36A2 2 0 0 1 4.49 12H2"/>
          </svg>
        );

        const Send = (props) => (
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
            <path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/>
          </svg>
        );

        const Heart = (props) => (
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
            <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/>
          </svg>
        );

        const Zap = (props) => (
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
            <path d="M4 14a1 1 0 0 1-.78-1.63l9.9-10.2a.5.5 0 0 1 .86.46l-1.92 6.02A1 1 0 0 0 13 10h7a1 1 0 0 1 .78 1.63l-9.9 10.2a.5.5 0 0 1-.86-.46l1.92-6.02A1 1 0 0 0 11 14z"/>
          </svg>
        );

        const RefreshCw = (props) => (
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
            <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M3 21v-5h5"/>
          </svg>
        );

        const LogOut = (props) => (
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/>
          </svg>
        );

        const Logue = () => {
          const [firebaseAuth, setFirebaseAuth] = useState(null);
          const [firebaseDb, setFirebaseDb] = useState(null);
          const [user, setUser] = useState(null);
          const [loadingAuth, setLoadingAuth] = useState(true);
          const [stravaConnected, setStravaConnected] = useState(false);
          const [activities, setActivities] = useState([]);
          const [messages, setMessages] = useState([]);
          const [userInput, setUserInput] = useState('');
          const [loading, setLoading] = useState(false);
          const [syncing, setSyncing] = useState(false);
          const messagesEndRef = useRef(null);

          useEffect(() => {
            initializeFirebase();
          }, []);

          useEffect(() => {
            if (!firebaseAuth) return;
            const unsubscribe = firebaseAuth.onAuthStateChanged(async (fbUser) => {
              if (fbUser) {
                setUser(fbUser);
                await loadUserData(fbUser.uid);
              } else {
                setUser(null);
              }
              setLoadingAuth(false);
            });
            return () => unsubscribe();
          }, [firebaseAuth]);

          useEffect(() => {
            handleStravaCallback();
          }, [user, firebaseDb]);

          useEffect(() => {
            scrollToBottom();
          }, [messages]);

          const initializeFirebase = async () => {
            try {
              const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
              const { getAuth } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
              const { getFirestore } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
              
              const app = initializeApp(FIREBASE_CONFIG);
              const auth = getAuth(app);
              const db = getFirestore(app);
              
              setFirebaseAuth(auth);
              setFirebaseDb(db);
            } catch (error) {
              console.error('Firebase error:', error);
              setLoadingAuth(false);
            }
          };

          const signInWithGoogle = async () => {
            try {
              const { signInWithPopup, GoogleAuthProvider } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
              const provider = new GoogleAuthProvider();
              await signInWithPopup(firebaseAuth, provider);
            } catch (error) {
              console.error('Sign in error:', error);
              alert('Sign in failed: ' + error.message);
            }
          };

          const signOut = async () => {
            try {
              const { signOut: fbSignOut } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
              await fbSignOut(firebaseAuth);
              setStravaConnected(false);
              setActivities([]);
              setMessages([]);
            } catch (error) {
              console.error('Sign out error:', error);
            }
          };

          const loadUserData = async (userId) => {
            try {
              const { doc, getDoc, collection, query, orderBy, limit, getDocs } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
              
              const userDoc = await getDoc(doc(firebaseDb, 'users', userId));
              if (userDoc.exists() && userDoc.data().stravaToken) {
                setStravaConnected(true);
                
                const activitiesQuery = query(
                  collection(firebaseDb, 'users', userId, 'activities'),
                  orderBy('date', 'desc'),
                  limit(10)
                );
                const activitiesSnap = await getDocs(activitiesQuery);
                const acts = activitiesSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                setActivities(acts);
                
                const messagesQuery = query(
                  collection(firebaseDb, 'users', userId, 'messages'),
                  orderBy('timestamp', 'asc')
                );
                const messagesSnap = await getDocs(messagesQuery);
                const msgs = messagesSnap.docs.map(doc => doc.data());
                
                if (msgs.length === 0) {
                  await startOnboarding(userId);
                } else {
                  setMessages(msgs);
                }
              }
            } catch (error) {
              console.error('Error loading user data:', error);
            }
          };

          const startOnboarding = async (userId) => {
            const welcomeMessage = {
              role: 'assistant',
              content: `Hi ${user?.displayName?.split(' ')[0] || 'there'}! ðŸ‘‹ I'm Logue, your AI running coach.

I've connected to your Strava account. Before we analyze your activities, tell me: **What are you training for?**

Examples: specific race, building fitness, comeback from injury, staying active`,
              timestamp: Date.now()
            };

            setMessages([welcomeMessage]);
            await saveMessage(userId, welcomeMessage);
          };

          const connectStrava = () => {
            const redirectUri = window.location.origin;
            const authUrl = `https://www.strava.com/oauth/authorize?client_id=${STRAVA_CLIENT_ID}&redirect_uri=${redirectUri}&response_type=code&scope=read,activity:read_all&state=${user.uid}`;
            window.location.href = authUrl;
          };

          const handleStravaCallback = async () => {
            if (!user || !firebaseDb) return;
            
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const state = urlParams.get('state');
            
            if (code && state === user.uid) {
              try {
                setSyncing(true);
                
                const response = await fetch(`${API_BASE}/api/strava-token`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ code, userId: user.uid })
                });
                
                if (!response.ok) throw new Error('Token exchange failed');
                
                const data = await response.json();
                
                const { doc, setDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                await setDoc(doc(firebaseDb, 'users', user.uid), {
                  stravaToken: data.access_token,
                  stravaRefreshToken: data.refresh_token,
                  stravaExpiresAt: data.expires_at,
                  stravaAthleteId: data.athlete.id,
                  email: user.email,
                  name: user.displayName,
                  lastSync: null
                }, { merge: true });
                
                setStravaConnected(true);
                await syncActivities();
                window.history.replaceState({}, document.title, window.location.pathname);
                setSyncing(false);
              } catch (error) {
                console.error('Strava auth error:', error);
                alert('Failed to connect to Strava: ' + error.message);
                setSyncing(false);
              }
            }
          };

          const syncActivities = async () => {
            if (!user || !firebaseDb) return;
            
            setSyncing(true);
            
            try {
              const { doc, getDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
              const userDoc = await getDoc(doc(firebaseDb, 'users', user.uid));
              const userData = userDoc.data();
              
              if (!userData?.stravaToken) throw new Error('No Strava token');
              
              const response = await fetch(`${API_BASE}/api/strava-sync`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ userId: user.uid, token: userData.stravaToken })
              });
              
              if (!response.ok) throw new Error('Sync failed');
              
              const { activities: newActivities } = await response.json();
              await loadUserData(user.uid);
              
              if (newActivities.length > 0) {
                const newMsg = {
                  role: 'assistant',
                  content: `âœ… Synced ${newActivities.length} activities from Strava!`,
                  timestamp: Date.now()
                };
                setMessages(prev => [...prev, newMsg]);
                await saveMessage(user.uid, newMsg);
              }
            } catch (error) {
              console.error('Sync error:', error);
              alert('Sync failed: ' + error.message);
            }
            
            setSyncing(false);
          };

          const saveMessage = async (userId, message) => {
            try {
              const { collection, addDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
              await addDoc(collection(firebaseDb, 'users', userId, 'messages'), message);
            } catch (error) {
              console.error('Error saving message:', error);
            }
          };

          const sendMessage = async () => {
            if (!userInput.trim() || loading || !user) return;

            const newUserMessage = { 
              role: 'user', 
              content: userInput,
              timestamp: Date.now()
            };
            
            setMessages(prev => [...prev, newUserMessage]);
            await saveMessage(user.uid, newUserMessage);
            setUserInput('');
            setLoading(true);

            try {
              const activityContext = activities.map(a => ({
                name: a.name,
                distance_km: a.distance,
                pace_per_km: a.pace,
                avg_hr: a.avgHeartrate,
                max_hr: a.maxHeartrate,
                cadence: a.cadence,
                date: new Date(a.date).toLocaleDateString()
              }));

              const conversationHistory = messages.slice(-10).map(m => ({
                role: m.role,
                content: m.content
              }));

              const systemPrompt = `You are Logue, an expert running coach. Analyze Strava data critically and ask specific questions about HR, cadence, pacing. Be proactive about concerning patterns.

Recent activities: ${JSON.stringify(activityContext, null, 2)}`;

              const response = await fetch("https://api.anthropic.com/v1/messages", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  model: "claude-sonnet-4-20250514",
                  max_tokens: 2000,
                  system: systemPrompt,
                  messages: [...conversationHistory, { role: 'user', content: userInput }]
                })
              });

              const data = await response.json();
              const reply = data.content.find(c => c.type === 'text')?.text || 'Sorry, error occurred.';
              
              const assistantMessage = {
                role: 'assistant',
                content: reply,
                timestamp: Date.now()
              };
              
              setMessages(prev => [...prev, assistantMessage]);
              await saveMessage(user.uid, assistantMessage);
              
            } catch (error) {
              console.error('Error:', error);
            }

            setLoading(false);
          };

          const scrollToBottom = () => {
            messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
          };

          if (loadingAuth) {
            return (
              <div className="min-h-screen bg-gray-50 flex items-center justify-center">
                <Activity className="w-12 h-12 text-orange-500 animate-pulse" />
              </div>
            );
          }

          if (!user) {
            return (
              <div className="min-h-screen bg-gradient-to-br from-orange-500 to-red-600 flex items-center justify-center p-4">
                <div className="bg-white rounded-2xl shadow-2xl p-12 max-w-2xl w-full">
                  <Activity className="w-20 h-20 mx-auto mb-6 text-orange-500" />
                  <h1 className="text-4xl font-bold text-gray-800 mb-4 text-center">Logue</h1>
                  <p className="text-xl text-gray-600 mb-8 text-center">
                    Your intelligent training partner
                  </p>
                  <button
                    onClick={signInWithGoogle}
                    className="w-full bg-white border-2 border-gray-300 text-gray-700 py-4 px-6 rounded-lg font-semibold hover:border-gray-400 transition flex items-center justify-center gap-3"
                  >
                    <svg className="w-6 h-6" viewBox="0 0 24 24">
                      <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                      <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                      <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                      <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    Sign in with Google
                  </button>
                </div>
              </div>
            );
          }

          if (!stravaConnected) {
            return (
              <div className="min-h-screen bg-gray-50 flex items-center justify-center p-4">
                <div className="bg-white rounded-2xl shadow-xl p-12 max-w-2xl w-full text-center">
                  <img 
                    src="https://upload.wikimedia.org/wikipedia/commons/c/cb/Strava_Logo.svg" 
                    alt="Strava" 
                    className="h-16 mx-auto mb-6"
                  />
                  <h2 className="text-3xl font-bold text-gray-800 mb-4">Connect Your Strava</h2>
                  <p className="text-gray-600 mb-8">
                    Logue needs access to your activities
                  </p>
                  
                  {syncing ? (
                    <div className="flex items-center justify-center gap-3 text-orange-600">
                      <RefreshCw className="w-6 h-6 animate-spin" />
                      <span>Connecting...</span>
                    </div>
                  ) : (
                    <button
                      onClick={connectStrava}
                      className="bg-orange-500 text-white py-4 px-8 rounded-lg font-semibold hover:bg-orange-600 transition inline-flex items-center gap-3"
                    >
                      <Activity className="w-6 h-6" />
                      Connect Strava
                    </button>
                  )}
                  
                  <button onClick={signOut} className="mt-6 text-sm text-gray-500 hover:text-gray-700">
                    Sign out
                  </button>
                </div>
              </div>
            );
          }

          return (
            <div className="h-screen flex flex-col bg-gray-50">
              <div className="bg-white border-b px-6 py-4 flex items-center justify-between shadow-sm">
                <div className="flex items-center gap-3">
                  <Activity className="w-6 h-6 text-orange-500" />
                  <h1 className="text-lg font-semibold text-gray-800">Logue</h1>
                  <span className="text-sm text-gray-500">â€¢ {user.displayName?.split(' ')[0]}</span>
                </div>
                <div className="flex items-center gap-4">
                  <button
                    onClick={syncActivities}
                    disabled={syncing}
                    className="flex items-center gap-2 text-sm text-gray-600 hover:text-gray-800 transition disabled:opacity-50"
                  >
                    <RefreshCw className={`w-4 h-4 ${syncing ? 'animate-spin' : ''}`} />
                    {syncing ? 'Syncing...' : 'Sync'}
                  </button>
                  <button onClick={signOut} className="flex items-center gap-2 text-sm text-gray-600 hover:text-gray-800">
                    <LogOut className="w-4 h-4" />
                    Sign Out
                  </button>
                </div>
              </div>

              <div className="flex-1 flex overflow-hidden">
                <div className="w-1/2 flex flex-col bg-white border-r">
                  <div className="px-6 py-4 border-b bg-gray-50">
                    <h2 className="font-semibold text-gray-700">Chat with Your Coach</h2>
                  </div>

                  <div className="flex-1 overflow-y-auto px-6 py-6 space-y-6">
                    {messages.map((msg, idx) => (
                      <div key={idx} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                        <div className={`max-w-[85%] ${
                          msg.role === 'user' 
                            ? 'bg-orange-500 text-white rounded-2xl rounded-br-sm' 
                            : 'bg-gray-100 text-gray-800 rounded-2xl rounded-bl-sm'
                        } px-5 py-3 shadow-sm`}>
                          <p className="text-sm leading-relaxed whitespace-pre-wrap">{msg.content}</p>
                        </div>
                      </div>
                    ))}
                    
                    {loading && (
                      <div className="flex justify-start">
                        <div className="bg-gray-100 rounded-2xl rounded-bl-sm px-5 py-3">
                          <div className="flex gap-1.5">
                            <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                            <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{ animationDelay: '0.1s' }}></div>
                            <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{ animationDelay: '0.2s' }}></div>
                          </div>
                        </div>
                      </div>
                    )}
                    <div ref={messagesEndRef} />
                  </div>

                  <div className="border-t bg-white px-6 py-4">
                    <div className="flex gap-3">
                      <input
                        type="text"
                        value={userInput}
                        onChange={(e) => setUserInput(e.target.value)}
                        onKeyPress={(e) => e.key === 'Enter' && sendMessage()}
                        placeholder="Type your message..."
                        className="flex-1 px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-orange-500"
                        disabled={loading}
                      />
                      <button
                        onClick={sendMessage}
                        disabled={loading || !userInput.trim()}
                        className="bg-orange-500 text-white p-3 rounded-xl hover:bg-orange-600 disabled:opacity-40"
                      >
                        <Send className="w-5 h-5" />
                      </button>
                    </div>
                  </div>
                </div>

                <div className="w-1/2 flex flex-col bg-gray-50">
                  <div className="px-6 py-4 border-b bg-white">
                    <h2 className="font-semibold text-gray-700">Recent Activities</h2>
                  </div>

                  <div className="flex-1 overflow-y-auto p-6 space-y-3">
                    {activities.length === 0 ? (
                      <div className="text-center py-12 text-gray-400">
                        <Activity className="w-16 h-16 mx-auto mb-4 opacity-50" />
                        <p>No activities yet</p>
                        <p className="text-sm mt-2">Click Sync to load from Strava</p>
                      </div>
                    ) : (
                      activities.map(activity => (
                        <div key={activity.id} className="bg-white rounded-lg p-4 border-2 border-gray-200">
                          <div className="flex items-start justify-between mb-3">
                            <div>
                              <h3 className="font-semibold text-gray-800">{activity.name}</h3>
                              <p className="text-sm text-gray-500">{new Date(activity.date).toLocaleDateString()}</p>
                            </div>
                          </div>
                          <div className="grid grid-cols-2 gap-3 text-sm">
                            <div>
                              <p className="text-gray-500">Distance</p>
                              <p className="font-semibold text-gray-800">{activity.distance} km</p>
                            </div>
                            <div>
                              <p className="text-gray-500">Pace</p>
                              <p className="font-semibold text-gray-800">{activity.pace}/km</p>
                            </div>
                            <div>
                              <p className="text-gray-500 flex items-center gap-1">
                                <Heart className="w-3 h-3" /> Avg HR
                              </p>
                              <p className="font-semibold">{activity.avgHeartrate} bpm</p>
                            </div>
                            <div>
                              <p className="text-gray-500 flex items-center gap-1">
                                <Zap className="w-3 h-3" /> Cadence
                              </p>
                              <p className="font-semibold">{activity.cadence} spm</p>
                            </div>
                          </div>
                        </div>
                      ))
                    )}
                  </div>
                </div>
              </div>
            </div>
          );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<Logue />);
    </script>
</body>
</html>
