<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Logue - AI Running Coach</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const FIREBASE_CONFIG = {
          apiKey: "AIzaSyCNDL5acClE7hbR2xshZtgrzSiJk7jq1Ko",
          authDomain: "logue-coach-app.firebaseapp.com",
          projectId: "logue-coach-app",
          storageBucket: "logue-coach-app.firebasestorage.app",
          messagingSenderId: "513654365822",
          appId: "1:513654365822:web:84835e52ba217cd255422f"
        };

        const STRAVA_CLIENT_ID = "184757";
        const API_BASE = "https://logue.vercel.app";

        if (!firebase.apps.length) {
          firebase.initializeApp(FIREBASE_CONFIG);
        }

        const Activity = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M22 12h-2.48a2 2 0 0 0-1.93 1.46l-2.35 8.36a.25.25 0 0 1-.48 0L9.24 2.18a.25.25 0 0 0-.48 0l-2.35 8.36A2 2 0 0 1 4.49 12H2"/></svg>;
        const Send = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>;

        function App() {
          const [user, setUser] = useState(null);
          const [loading, setLoading] = useState(true);
          const [phase, setPhase] = useState('connect');
          const [messages, setMessages] = useState([]);
          const [input, setInput] = useState('');
          const [chatLoading, setChatLoading] = useState(false);
          const messagesEndRef = useRef(null);

          useEffect(() => {
            const storedUser = localStorage.getItem('logue_user');
            const storedGoal = localStorage.getItem('logue_goal');
            const storedFitness = localStorage.getItem('logue_fitness');
            
            if (storedUser) {
              setUser(JSON.parse(storedUser));
              if (storedGoal && storedFitness) {
                setPhase('main');
              } else if (storedGoal) {
                setPhase('fitness_assessment');
              } else {
                setPhase('goal_intake');
                setMessages([{
                  role: 'assistant',
                  content: "Hi! I'm Logue, your AI running coach. What are you training for?",
                  timestamp: Date.now()
                }]);
              }
            }
            setLoading(false);
          }, []);

          useEffect(() => {
            messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
          }, [messages]);

          useEffect(() => {
            const handleCallback = async () => {
              const urlParams = new URLSearchParams(window.location.search);
              const code = urlParams.get('code');
              const state = urlParams.get('state');
              
              if (code && state === localStorage.getItem('strava_state')) {
                try {
                  const response = await fetch(`${API_BASE}/api/strava-token`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code })
                  });
                  
                  const data = await response.json();
                  const userData = {
                    athleteId: data.athlete.id.toString(),
                    name: `${data.athlete.firstname} ${data.athlete.lastname}`,
                    stravaToken: data.access_token
                  };
                  
                  localStorage.setItem('logue_user', JSON.stringify(userData));
                  setUser(userData);
                  setPhase('goal_intake');
                  setMessages([{
                    role: 'assistant',
                    content: "Hi! I'm Logue, your AI running coach. What are you training for?",
                    timestamp: Date.now()
                  }]);
                  
                  window.history.replaceState({}, '', '/');
                  localStorage.removeItem('strava_state');
                } catch (error) {
                  alert('Connection failed: ' + error.message);
                }
              }
            };
            handleCallback();
          }, []);

          const connectStrava = () => {
            const state = Math.random().toString(36).substring(7);
            localStorage.setItem('strava_state', state);
            const authUrl = `https://www.strava.com/oauth/authorize?client_id=${STRAVA_CLIENT_ID}&redirect_uri=${window.location.origin}&response_type=code&scope=read,activity:read_all&state=${state}`;
            window.location.href = authUrl;
          };

          const assessFitness = async (goalData) => {
            console.log('Starting fitness assessment...');
            setChatLoading(true);
            
            try {
              console.log('Syncing Strava activities...');
              const syncResponse = await fetch(`${API_BASE}/api/strava-sync`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token: user.stravaToken })
              });
              
              console.log('Sync response status:', syncResponse.status);
              const syncData = await syncResponse.json();
              console.log('Synced activities:', syncData);
              
              const { activities } = syncData;
              
              if (!activities || activities.length === 0) {
                throw new Error('No activities found');
              }

              const assessmentPrompt = `You are Logue, an expert running coach. Analyze this runner's recent training history and their goal.

GOAL:
${JSON.stringify(goalData, null, 2)}

RECENT ACTIVITIES (last 30 days):
${JSON.stringify(activities.slice(0, 15).map(a => ({
  name: a.name,
  date: a.date,
  distance_km: a.distance,
  pace: a.pace,
  avgHeartrate: a.avgHeartrate,
  cadence: a.cadence
})), null, 2)}

YOUR TASK:
1. Assess their current fitness level (beginner/intermediate/advanced)
2. Calculate their average weekly volume over the last 4 weeks
3. Note their typical pace range
4. Identify their longest recent run
5. Note any concerning patterns (inconsistency, no long runs, etc.)

Provide a 2-3 sentence assessment that's encouraging but honest. Then say you're ready to create their personalized plan.`;

              console.log('Calling Claude for fitness assessment...');
              const response = await fetch(`${API_BASE}/api/claude-chat`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  max_tokens: 500,
                  messages: [{ role: 'user', content: assessmentPrompt }]
                })
              });

              const data = await response.json();
              console.log('Claude response:', data);
              const assessment = data.content?.find(c => c.type === 'text')?.text || 'Assessment complete.';
              
              setMessages(prev => [...prev, {
                role: 'assistant',
                content: assessment,
                timestamp: Date.now()
              }]);
              
              localStorage.setItem('logue_fitness', JSON.stringify({ activities, assessment }));
              
              setTimeout(() => {
                setMessages(prev => [...prev, {
                  role: 'assistant',
                  content: 'Now let me create your personalized training plan...',
                  timestamp: Date.now()
                }]);
                setTimeout(() => setPhase('main'), 2000);
              }, 2000);
              
            } catch (error) {
              console.error('Fitness assessment error:', error);
              setMessages(prev => [...prev, {
                role: 'assistant',
                content: 'I had trouble accessing your Strava data. Let me create a plan based on your goal instead.',
                timestamp: Date.now()
              }]);
              setTimeout(() => setPhase('main'), 2000);
            }
            
            setChatLoading(false);
          };

          const sendMessage = async () => {
            if (!input.trim() || chatLoading) return;

            const userMsg = { role: 'user', content: input, timestamp: Date.now() };
            setMessages(prev => [...prev, userMsg]);
            setInput('');
            setChatLoading(true);

            try {
              if (phase === 'goal_intake') {
                const response = await fetch(`${API_BASE}/api/goal-intake`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({
                    messages: [...messages, userMsg],
                    goalData: null
                  })
                });

                const data = await response.json();
                setMessages(prev => [...prev, {
                  role: 'assistant',
                  content: data.reply,
                  timestamp: Date.now()
                }]);

                if (data.isComplete && data.goalData) {
                  localStorage.setItem('logue_goal', JSON.stringify(data.goalData));
                  
                  setMessages(prev => [...prev, {
                    role: 'assistant',
                    content: 'Perfect! Let me analyze your recent Strava activities to understand your current fitness level...',
                    timestamp: Date.now()
                  }]);
                  
                  await assessFitness(data.goalData);
                }
              } else {
                setMessages(prev => [...prev, {
                  role: 'assistant',
                  content: 'Main chat not implemented yet',
                  timestamp: Date.now()
                }]);
              }
            } catch (error) {
              console.error(error);
            }

            setChatLoading(false);
          };

          if (loading) {
            return (
              <div className="min-h-screen bg-gray-50 flex items-center justify-center">
                <Activity />
              </div>
            );
          }

          if (phase === 'connect') {
            return (
              <div className="min-h-screen bg-gradient-to-br from-orange-500 to-red-600 flex items-center justify-center p-4">
                <div className="bg-white rounded-2xl shadow-2xl p-12 max-w-2xl w-full text-center">
                  <Activity />
                  <h1 className="text-4xl font-bold text-gray-800 mb-4 mt-6">Logue</h1>
                  <p className="text-xl text-gray-600 mb-8">Your AI running coach</p>
                  <button
                    onClick={connectStrava}
                    className="bg-orange-500 text-white py-4 px-8 rounded-lg font-semibold hover:bg-orange-600 transition"
                  >
                    Connect with Strava
                  </button>
                </div>
              </div>
            );
          }

          if (phase === 'goal_intake' || phase === 'fitness_assessment') {
            return (
              <div className="h-screen flex flex-col bg-gray-50">
                <div className="bg-white border-b px-6 py-4 shadow-sm">
                  <h1 className="text-lg font-semibold text-gray-800">
                    Logue • {phase === 'goal_intake' ? 'Goal Setup' : 'Fitness Assessment'}
                  </h1>
                </div>

                <div className="flex-1 flex items-center justify-center p-4">
                  <div className="w-full max-w-2xl bg-white rounded-2xl shadow-xl flex flex-col h-[600px]">
                    <div className="flex-1 overflow-y-auto px-6 py-6 space-y-6">
                      {messages.map((msg, idx) => (
                        <div key={idx} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                          <div className={`max-w-[85%] px-5 py-3 rounded-2xl shadow-sm ${
                            msg.role === 'user' 
                              ? 'bg-orange-500 text-white rounded-br-sm' 
                              : 'bg-gray-100 text-gray-800 rounded-bl-sm'
                          }`}>
                            <p className="text-sm leading-relaxed whitespace-pre-wrap">{msg.content}</p>
                          </div>
                        </div>
                      ))}
                      
                      {chatLoading && (
                        <div className="flex justify-start">
                          <div className="bg-gray-100 rounded-2xl rounded-bl-sm px-5 py-3">
                            <div className="flex gap-1.5">
                              <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                              <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{animationDelay: '0.1s'}}></div>
                              <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{animationDelay: '0.2s'}}></div>
                            </div>
                          </div>
                        </div>
                      )}
                      <div ref={messagesEndRef} />
                    </div>

                    <div className="border-t px-6 py-4">
                      <div className="flex gap-3">
                        <input
                          type="text"
                          value={input}
                          onChange={(e) => setInput(e.target.value)}
                          onKeyPress={(e) => e.key === 'Enter' && sendMessage()}
                          placeholder={phase === 'goal_intake' ? "Type your answer..." : ""}
                          className="flex-1 px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-orange-500"
                          disabled={chatLoading || phase === 'fitness_assessment'}
                          autoFocus={phase === 'goal_intake'}
                        />
                        <button
                          onClick={sendMessage}
                          disabled={chatLoading || !input.trim() || phase === 'fitness_assessment'}
                          className="bg-orange-500 text-white p-3 rounded-xl hover:bg-orange-600 disabled:opacity-40"
                        >
                          <Send />
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            );
          }

          return (
            <div className="h-screen flex flex-col bg-gray-50">
              <div className="bg-white border-b px-6 py-4 shadow-sm">
                <div className="flex items-center justify-between">
                  <h1 className="text-lg font-semibold text-gray-800">Logue • {user?.name}</h1>
                  <button
                    onClick={() => {
                      localStorage.clear();
                      window.location.reload();
                    }}
                    className="text-sm text-gray-600 hover:text-gray-800"
                  >
                    Sign Out
                  </button>
                </div>
              </div>
              <div className="flex-1 flex items-center justify-center">
                <p className="text-gray-600">Main app view - Coming soon!</p>
              </div>
            </div>
          );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
